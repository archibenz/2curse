import math

def get_float(prompt, default):
    """Запрашивает ввод числа с возможностью оставить значение по умолчанию."""
    try:
        s = input(f"{prompt} [default: {default}]: ")
        return float(s) if s.strip() != "" else default
    except ValueError:
        print("Некорректный ввод, используется значение по умолчанию.")
        return default

def main():
    print("Лабораторный расчет выбросов SO₂ по задаче №2\n")
    
    # Ввод исходных данных (по умолчанию – данные из первой лабораторной работы)
    print("Введите исходные данные (нажмите Enter, чтобы оставить значение по умолчанию):")
    H = get_float("Высота трубы H (м)", 20)             # м
    D = get_float("Диаметр трубы D (м)", 1.1)            # м
    w0 = get_float("Скорость выхода газов w₀ (м/с)", 7)   # м/с
    T_g = get_float("Температура газов T₍г₎ (°C)", 120)   # °C
    T_air = get_float("Температура воздуха T₍в₎ (°C)", 17) # °C
    M = get_float("Мощность выброса (М), г/с", 8.6)       # г/с
    Vl = get_float("Объемный расход Vl (м³/с)", 6.65)      # м³/с
    f = get_float("Коэффициент f", 1.31, )               # безразмерный
    m_coeff = get_float("Коэффициент m", 0.8649)          # безразмерный (не используется в расчетах 2 лабы)
    Cm = get_float("Максимальная концентрация Cm (мг/м³)", 0.33)  # мг/м³
    PDK_ss = get_float("Среднесуточная ПДК (мг/м³)", 0.05)       # мг/м³
    Sf = get_float("Фоновая концентрация Sf (мг/м³)", 0.01)       # мг/м³
    A = get_float("Коэффициент A", 160)                         # (используется в первой лабе)
    
    # Расчет дополнительных параметров
    delta_T = T_g - T_air  # разность температур
    
    # 1. Расстояние от источника до точки максимальной концентрации (хₘ)
    # Формула для ν_m из методички
    nu_m = 0.65 * (Vl * delta_T / H) ** (1/3)

    # Расчет коэффициента d в зависимости от nu_m
    if nu_m >= 2:
        d = 7 * math.sqrt(nu_m) * (1 + 0.28 * (f ** (1/3)))
    elif 0.5 <= nu_m < 2:
        d = 4.95 * nu_m * (1 + 0.28 * (f ** (1/3)))
    else:
        d = 2 * math.sqrt(nu_m) * (1 + 0.28 * (f ** (1/3)))

    # Расчет x_m по формуле из методички
    F = 1  # для газов
    x_m = ((5 - F) / 4) * d * H
    
    # 2. Опасная скорость ветра (iₘ)
    # Затем опасная скорость ветра:
    #   iₘ = 1.3 * √(νₘ)
    i_m = 1.3 * math.sqrt(nu_m)
    
    # 3. Расчет приземных концентраций на расстояниях 50 м и 500 м
    # Функция для расчета безразмерного коэффициента S1:
    def calc_S1(x, x_m):
        ratio = x / x_m
        if ratio <= 1:
            # Согласно условию: S1 = 3*(x/x_m)^4 – 8*(x/x_m)^3 + 6*(x/x_m)^2
            return 3 * (ratio)**4 - 8 * (ratio)**3 + 6 * (ratio)**2
        else:
            # При ratio >= 1: S1 = 1.13 / (0.13*(x/x_m)^2 + 1)
            return 1.13 / (0.13 * (ratio)**2 + 1)
    
    S1_50 = calc_S1(50, x_m)
    S1_500 = calc_S1(500, x_m)
    
    c_50 = S1_50 * Cm
    c_500 = S1_500 * Cm
    
    # Расчет предельно допустимого выброса (ПДВ) по методичке
    # ПДВ = (ПДКсс - Сф) * H² * ³√(Vl * ΔT) / (A * F * m * n * η)
    F = 1  # для газов
    n = 1
    eta = 1

    cubic_root_Vl_T = (Vl * delta_T) ** (1/3)
    PDV = (PDK_ss - Sf) * (H ** 2) * cubic_root_Vl_T / (A * F * m_coeff * n * eta)

    # Вывод результатов в терминал
    print("\n--- Результаты расчета ---\n")
    print("Исходные данные:")
    print(f"  Город: Вологда")
    print(f"  Высота трубы H = {H} м")
    print(f"  Диаметр трубы D = {D} м")
    print(f"  Скорость выхода газов w₀ = {w0} м/с")
    print(f"  Температура газов T₍г₎ = {T_g} °C")
    print(f"  Температура воздуха T₍в₎ = {T_air} °C")
    print(f"  Масса выбросов M = {M} г/с")
    print(f"  Объемный расход Vl = {Vl} м³/с")
    print(f"  Коэффициент f = {f}")
    print(f"  Максимальная концентрация Cm = {Cm} мг/м³")
    print(f"  ПДКсс = {PDK_ss} мг/м³, Фоновая концентрация Sf = {Sf} мг/м³")
    print(f"  ΔT = {delta_T} °C")
    
    print("\n1. Расстояние до точки максимальной концентрации (xₘ):")
    print(f"   xₘ = (5 - F)/4 * d * H = (5 - {F})/4 * {d:.3f} * {H} = {x_m:.2f} м")
    
    print("\n2. Расчет νₘ и коэффициента d:")
    print(f"   νₘ = 0.65 * ³√(Vl * ΔT / H) = 0.65 * ³√({Vl} * {delta_T} / {H}) = {nu_m:.3f}")
    print(f"   Коэффициент d = {d:.3f} по выбранной формуле при νₘ = {nu_m:.3f}")
    
    print("\n3. Приземные концентрации:")
    print(f"   Для x = 50 м:")
    print(f"      Отношение x/xₘ = 50 / {x_m:.2f} = {50/x_m:.2f}")
    print(f"      S1(50) = {S1_50:.4f}")
    print(f"      c₅₀ = S1(50) * Cm = {S1_50:.4f} * {Cm} = {c_50:.4f} мг/м³")
    print(f"   Для x = 500 м:")
    print(f"      Отношение x/xₘ = 500 / {x_m:.2f} = {500/x_m:.2f}")
    print(f"      S1(500) = {S1_500:.4f}")
    print(f"      c₅₀₀ = S1(500) * Cm = {S1_500:.4f} * {Cm} = {c_500:.4f} мг/м³")
    
    print("\n4. Предельно допустимый выброс (ПДВ):")
    print(f"   ПДВ = (ПДКсс - Sf) * H² * ³√(Vl * ΔT) / (A * F * m * n * η)")
    print(f"   ПДВ = ({PDK_ss} - {Sf}) * {H}² * ³√({Vl} * {delta_T}) / ({A} * {F} * {m_coeff} * {n} * {eta})")
    print(f"   ПДВ = ({PDK_ss - Sf}) * {H**2} * {cubic_root_Vl_T:.4f} / ({A * F * m_coeff * n * eta})")
    print(f"   ПДВ = {PDV:.4f} г/с")
    
    print("\n--- Конец отчета ---")
    
    while True:
        print("\nХотите изменить какое-либо значение и пересчитать? (yes/no)")
        choice = input(">> ").strip().lower()
        if choice == 'no':
            print("Завершение программы.")
            break
        elif choice == 'yes':
            print("\nВведите название переменной, которую хотите изменить (например, H, D, w0 и т.д.):")
            var_name = input(">> ").strip()

            # Словарь всех переменных, которые можно менять
            variables = {
                'H': H,
                'D': D,
                'w0': w0,
                'T_g': T_g,
                'T_air': T_air,
                'M': M,
                'Vl': Vl,
                'f': f,
                'm_coeff': m_coeff,
                'Cm': Cm,
                'PDK_ss': PDK_ss,
                'Sf': Sf,
                'A': A
            }

            if var_name in variables:
                new_value = float(input(f"Введите новое значение для {var_name}: "))
                # Обновляем значение
                locals()[var_name] = new_value

                # Пересчитываем параметры на основе новых значений
                delta_T = T_g - T_air
                nu_m = 0.65 * (Vl * delta_T / H) ** (1/3)

                # Расчет коэффициента d в зависимости от nu_m
                if nu_m >= 2:
                    d = 7 * math.sqrt(nu_m) * (1 + 0.28 * (f ** (1/3)))
                elif 0.5 <= nu_m < 2:
                    d = 4.95 * nu_m * (1 + 0.28 * (f ** (1/3)))
                else:
                    d = 2 * math.sqrt(nu_m) * (1 + 0.28 * (f ** (1/3)))

                x_m = ((5 - F) / 4) * d * H
                i_m = 1.3 * math.sqrt(nu_m)
                S1_50 = calc_S1(50, x_m)
                S1_500 = calc_S1(500, x_m)
                c_50 = S1_50 * Cm
                c_500 = S1_500 * Cm
                
                # Расчет предельно допустимого выброса (ПДВ) по методичке
                # ПДВ = (ПДКсс - Сф) * H² * ³√(Vl * ΔT) / (A * F * m * n * η)
                F = 1  # для газов
                n = 1
                eta = 1

                cubic_root_Vl_T = (Vl * delta_T) ** (1/3)
                PDV = (PDK_ss - Sf) * (H ** 2) * cubic_root_Vl_T / (A * F * m_coeff * n * eta)

                # Вывод обновленных результатов
                print("\n--- Обновленные результаты расчета ---\n")
                print("Исходные данные:")
                print(f"  Город: Вологда")
                print(f"  Высота трубы H = {H} м")
                print(f"  Диаметр трубы D = {D} м")
                print(f"  Скорость выхода газов w₀ = {w0} м/с")
                print(f"  Температура газов T₍г₎ = {T_g} °C")
                print(f"  Температура воздуха T₍в₎ = {T_air} °C")
                print(f"  Масса выбросов M = {M} г/с")
                print(f"  Объемный расход Vl = {Vl} м³/с")
                print(f"  Коэффициент f = {f}")
                print(f"  Максимальная концентрация Cm = {Cm} мг/м³")
                print(f"  ПДКсс = {PDK_ss} мг/м³, Фоновая концентрация Sf = {Sf} мг/м³")
                print(f"  ΔT = {delta_T} °C")
                
                print("\n1. Расстояние до точки максимальной концентрации (xₘ):")
                print(f"   xₘ = (5 - F)/4 * d * H = (5 - {F})/4 * {d:.3f} * {H} = {x_m:.2f} м")
                
                print("\n2. Расчет νₘ и коэффициента d:")
                print(f"   νₘ = 0.65 * ³√(Vl * ΔT / H) = 0.65 * ³√({Vl} * {delta_T} / {H}) = {nu_m:.3f}")
                print(f"   Коэффициент d = {d:.3f} по выбранной формуле при νₘ = {nu_m:.3f}")
                
                print("\n3. Приземные концентрации:")
                print(f"   Для x = 50 м:")
                print(f"      Отношение x/xₘ = 50 / {x_m:.2f} = {50/x_m:.2f}")
                print(f"      S1(50) = {S1_50:.4f}")
                print(f"      c₅₀ = S1(50) * Cm = {S1_50:.4f} * {Cm} = {c_50:.4f} мг/м³")
                print(f"   Для x = 500 м:")
                print(f"      Отношение x/xₘ = 500 / {x_m:.2f} = {500/x_m:.2f}")
                print(f"      S1(500) = {S1_500:.4f}")
                print(f"      c₅₀₀ = S1(500) * Cm = {S1_500:.4f} * {Cm} = {c_500:.4f} мг/м³")
                
                print("\n4. Предельно допустимый выброс (ПДВ):")
                print(f"   ПДВ = (ПДКсс - Sf) * H² * ³√(Vl * ΔT) / (A * F * m * n * η)")
                print(f"   ПДВ = ({PDK_ss} - {Sf}) * {H}² * ³√({Vl} * {delta_T}) / ({A} * {F} * {m_coeff} * {n} * {eta})")
                print(f"   ПДВ = ({PDK_ss - Sf}) * {H**2} * {cubic_root_Vl_T:.4f} / ({A * F * m_coeff * n * eta})")
                print(f"   ПДВ = {PDV:.4f} г/с")
            
            else:
                print(f"Переменная {var_name} не найдена. Попробуйте снова.")

if __name__ == '__main__':
    main()